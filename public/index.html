<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Management System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .content {
      padding: 30px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #eee;
    }

    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1em;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-btn:hover {
      color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-section, .upload-section {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #e9ecef;
      color: #333;
    }

    .btn-secondary:hover {
      background: #dee2e6;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      background: #f0f4ff;
    }

    .upload-area.dragover {
      background: #e9ecef;
      border-color: #764ba2;
    }

    .upload-area p {
      margin: 10px 0;
      color: #666;
    }

    .upload-area input[type="file"] {
      display: none;
    }

    .books-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .books-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .books-table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
    }

    .books-table td {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
    }

    .books-table tbody tr:hover {
      background: #f8f9fa;
    }

    .books-table tbody tr:last-child td {
      border-bottom: none;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 0.9em;
    }

    .message {
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      animation: slideIn 0.3s ease;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 0.9em;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .stat-card .number {
      font-size: 2.5em;
      font-weight: bold;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .search-section {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .search-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .search-group input {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 0.95em;
    }

    .search-group select {
      padding: 10px 14px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 0.95em;
      min-width: 150px;
    }

    .duplicate-warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .duplicate-warning h4 {
      color: #856404;
      margin-bottom: 8px;
    }

    .duplicate-warning p {
      color: #856404;
      margin: 4px 0;
    }

    .duplicate-action {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }

    .input-hint {
      font-size: 0.85em;
      color: #666;
      margin-top: 4px;
    }

    .validation-error {
      color: #dc3545;
      font-size: 0.85em;
      margin-top: 4px;
    }

    .validation-success {
      color: #28a745;
      font-size: 0.85em;
      margin-top: 4px;
    }

    .import-summary {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 16px;
      border-radius: 6px;
      margin-top: 16px;
    }

    .import-summary h4 {
      color: #1976D2;
      margin-bottom: 12px;
    }

    .import-summary-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #b3d9ff;
    }

    .import-summary-item:last-child {
      border-bottom: none;
    }

    .summary-stat {
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìö Library Management System</h1>
      <p>Manage your book collection efficiently</p>
    </div>

    <div class="content">
      <div id="message-container"></div>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('add-book')">Add Book</button>
        <button class="tab-btn" onclick="switchTab('upload-csv')">Import CSV</button>
        <button class="tab-btn" onclick="switchTab('books-list')">View Books</button>
      </div>

      <!-- Add Book Tab -->
      <div id="add-book" class="tab-content active">
        <div class="form-section">
          <h2>Add New Book</h2>
          
          <!-- Duplicate Check Warning -->
          <div id="duplicateWarning" class="duplicate-warning" style="display: none;">
            <h4>‚ö†Ô∏è Book ID Already Exists</h4>
            <p><strong>Book Name:</strong> <span id="existingBookName"></span></p>
            <p><strong>Author:</strong> <span id="existingAuthor"></span></p>
            <p><strong>Existing Copies:</strong> <span id="existingQuantity"></span></p>
            <p style="font-size: 0.9em; color: #666; margin-top: 8px;">
              üí° Enter quantity to add more copies. Each copy will get a unique auto-generated ID.
            </p>
            <div class="duplicate-action">
              <button type="button" class="btn-primary btn-small" onclick="updateExistingBook()">Add More Copies</button>
              <button type="button" class="btn-secondary btn-small" onclick="clearDuplicateWarning()">Use Different ID</button>
            </div>
          </div>

          <form id="addBookForm">
            <div class="form-group">
              <label for="bookId">Book ID * 
                <span class="input-hint">(e.g., 315030, starting unique identifier)</span>
              </label>
              <input type="text" id="bookId" placeholder="Enter unique book ID" required>
              <div id="bookIdValidation"></div>
            </div>

            <div class="form-group">
              <label for="bookName">Book Name *</label>
              <input type="text" id="bookName" placeholder="Enter book name" required>
            </div>

            <div class="form-group">
              <label for="authorName">Author Name *</label>
              <input type="text" id="authorName" placeholder="Enter author name" required>
            </div>

            <div class="form-group">
              <label for="isbn">ISBN *
                <span class="input-hint">(10 or 13 digits, e.g., 978-0-1234-5678-9)</span>
              </label>
              <input type="text" id="isbn" placeholder="Enter ISBN" required>
              <div id="isbnValidation"></div>
            </div>

            <div class="form-group">
              <label for="quantity">Number of Copies
                <span class="input-hint">(Each copy gets a unique sequential ID)</span>
              </label>
              <input type="number" id="quantity" placeholder="Enter number of copies" value="1" min="1" max="1000">
            </div>

            <div class="button-group">
              <button type="submit" class="btn-primary">Add Book</button>
              <button type="reset" class="btn-secondary" onclick="clearDuplicateWarning()">Clear</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Upload CSV Tab -->
      <div id="upload-csv" class="tab-content">
        <div class="upload-section">
          <h2>Import Books from CSV</h2>
          <p style="margin-bottom: 20px; color: #666;">Expected CSV format: Book ID, Book Name, Author Name, ISBN, Quantity</p>
          <div class="upload-area" id="uploadArea">
            <p style="font-size: 1.1em; font-weight: 600;">üìÅ Drop your CSV file here</p>
            <p>or</p>
            <button class="btn-primary" onclick="document.getElementById('csvFile').click()">Choose File</button>
            <input type="file" id="csvFile" accept=".csv" style="display: none;">
          </div>
        </div>
      </div>

      <!-- View Books Tab -->
      <div id="books-list" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>Book Collection</h2>
          <button class="btn-secondary btn-small" onclick="downloadCSV()">üì• Download CSV</button>
        </div>
        
        <div class="stats">
          <div class="stat-card">
            <h3>Unique Titles</h3>
            <div class="number" id="totalBooks">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Copies</h3>
            <div class="number" id="totalQuantity">0</div>
          </div>
          <div class="stat-card">
            <h3>Last Updated</h3>
            <div class="number" id="lastUpdated" style="font-size: 1em;">-</div>
          </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
          <h3>Search & Filter</h3>
          <div class="search-group">
            <input type="text" id="searchInput" placeholder="Search books...">
            <select id="searchType">
              <option value="">All Fields</option>
              <option value="id">Book ID</option>
              <option value="name">Book Name</option>
              <option value="author">Author</option>
              <option value="isbn">ISBN</option>
            </select>
            <button class="btn-primary btn-small" onclick="performSearch()">üîç Search</button>
            <button class="btn-secondary btn-small" onclick="clearSearch()">Clear</button>
          </div>
        </div>

        <div id="booksContainer"></div>
      </div>
    </div>
  </div>

  <script>
    let currentBooks = [];
    let isDuplicateMode = false;

    // Tab switching
    function switchTab(tabName) {
      const contents = document.querySelectorAll('.tab-content');
      const buttons = document.querySelectorAll('.tab-btn');

      contents.forEach(content => content.classList.remove('active'));
      buttons.forEach(btn => btn.classList.remove('active'));

      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      if (tabName === 'books-list') {
        loadBooks();
      }
    }

    // Show message
    function showMessage(message, type = 'info') {
      const container = document.getElementById('message-container');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;

      container.innerHTML = '';
      container.appendChild(messageDiv);

      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // Validate ISBN format
    function validateISBN(isbn) {
      const isbnClean = isbn.replace(/-/g, '');
      return /^\d{10}(\d{3})?$|^97[89]\d{10}(\d{3})?$/.test(isbnClean);
    }

    // Validate Book ID
    function validateBookId(bookId) {
      return /^[a-zA-Z0-9]+$/.test(bookId);
    }

    // Real-time ISBN validation
    document.getElementById('isbn').addEventListener('change', () => {
      const isbn = document.getElementById('isbn').value;
      const validationDiv = document.getElementById('isbnValidation');
      
      if (isbn) {
        if (validateISBN(isbn)) {
          validationDiv.innerHTML = '<span class="validation-success">‚úì Valid ISBN</span>';
        } else {
          validationDiv.innerHTML = '<span class="validation-error">‚úó Invalid ISBN format (use 10 or 13 digits)</span>';
        }
      }
    });

    // Real-time Book ID validation & duplicate check
    document.getElementById('bookId').addEventListener('change', async () => {
      const bookId = document.getElementById('bookId').value;
      const validationDiv = document.getElementById('bookIdValidation');
      
      if (bookId) {
        if (!validateBookId(bookId)) {
          validationDiv.innerHTML = '<span class="validation-error">‚úó Book ID must be alphanumeric</span>';
          clearDuplicateWarning();
          return;
        }
        validationDiv.innerHTML = '<span class="validation-success">‚úì Valid format</span>';
        
        // Check for duplicates
        checkDuplicate();
      }
    });

    // Real-time Book ID check as you type (with debounce)
    let debounceTimer;
    document.getElementById('bookId').addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const bookId = document.getElementById('bookId').value;
        if (bookId && validateBookId(bookId)) {
          checkDuplicateById(bookId);
        }
      }, 500); // Check after 500ms of no typing
    });

    // Real-time ISBN duplicate check
    document.getElementById('isbn').addEventListener('change', () => {
      checkDuplicate();
    });

    // Check for duplicate by Book ID only (fast check)
    async function checkDuplicateById(bookId) {
      if (!bookId) return;

      try {
        const response = await fetch(`/api/books`);
        const books = await response.json();
        
        // Find exact match by Book ID
        const exactMatch = books.find(b => b.bookId === bookId);
        
        if (exactMatch) {
          // Find all copies of the same book (same name)
          const allCopies = books.filter(b => b.bookName === exactMatch.bookName);
          const copyIds = allCopies.map(b => b.bookId).sort((a, b) => parseInt(a) - parseInt(b));
          
          isDuplicateMode = true;
          const warning = document.getElementById('duplicateWarning');
          document.getElementById('existingBookName').textContent = exactMatch.bookName;
          document.getElementById('existingAuthor').textContent = exactMatch.authorName;
          document.getElementById('existingQuantity').textContent = `${allCopies.length} copies (IDs: ${copyIds.join(', ')})`;
          warning.style.display = 'block';
        } else {
          clearDuplicateWarning();
        }
      } catch (error) {
        console.error('Error checking duplicate:', error);
      }
    }

    // Check for duplicate books (full check with ISBN)
    async function checkDuplicate() {
      const bookId = document.getElementById('bookId').value;
      const isbn = document.getElementById('isbn').value;

      if (!bookId) return;

      try {
        const response = await fetch(`/api/books`);
        const books = await response.json();
        
        // Find exact match by Book ID
        const exactMatch = books.find(b => b.bookId === bookId);
        
        if (exactMatch) {
          // Find all copies of the same book (same name)
          const allCopies = books.filter(b => b.bookName === exactMatch.bookName);
          const copyIds = allCopies.map(b => b.bookId).sort((a, b) => parseInt(a) - parseInt(b));
          
          isDuplicateMode = true;
          const warning = document.getElementById('duplicateWarning');
          document.getElementById('existingBookName').textContent = exactMatch.bookName;
          document.getElementById('existingAuthor').textContent = exactMatch.authorName;
          document.getElementById('existingQuantity').textContent = `${allCopies.length} copies (IDs: ${copyIds.join(', ')})`;
          warning.style.display = 'block';
        } else {
          clearDuplicateWarning();
        }
      } catch (error) {
        console.error('Error checking duplicate:', error);
      }
    }

    // Clear duplicate warning
    function clearDuplicateWarning() {
      isDuplicateMode = false;
      document.getElementById('duplicateWarning').style.display = 'none';
    }

    // Update existing book quantity - creates new copies with unique IDs
    async function updateExistingBook() {
      const bookId = document.getElementById('bookId').value;
      const additionalQuantity = parseInt(document.getElementById('quantity').value) || 1;

      try {
        const response = await fetch('/api/add-book', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookId,
            bookName: document.getElementById('bookName').value,
            authorName: document.getElementById('authorName').value,
            isbn: document.getElementById('isbn').value,
            quantity: additionalQuantity,
            action: 'update'
          })
        });

        const result = await response.json();

        if (response.ok) {
          // Show the new IDs that were created
          if (result.books && result.books.length > 0) {
            const newIds = result.books.map(b => b.bookId).join(', ');
            showMessage(`‚úÖ Added ${result.books.length} new copies with IDs: ${newIds}`, 'success');
            showCreatedBooksSummary(result.books);
          } else {
            showMessage(`‚úÖ ${result.message}`, 'success');
          }
          document.getElementById('addBookForm').reset();
          clearDuplicateWarning();
        } else {
          showMessage('‚ùå ' + (result.error || 'Error updating book'), 'error');
        }
      } catch (error) {
        showMessage('‚ùå Error: ' + error.message, 'error');
      }
    }

    // Show summary of created books with their IDs
    function showCreatedBooksSummary(books) {
      const container = document.getElementById('message-container');
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'import-summary';
      summaryDiv.innerHTML = '<h4>üìö Created Books</h4>';
      
      books.forEach(book => {
        summaryDiv.innerHTML += `
          <div class="import-summary-item">
            <span><strong>ID:</strong> ${book.bookId}</span>
            <span>${book.bookName}</span>
            <span>${book.authorName}</span>
          </div>
        `;
      });
      
      container.appendChild(summaryDiv);
    }

    // Add book form submission
    document.getElementById('addBookForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const bookId = document.getElementById('bookId').value;
      const isbn = document.getElementById('isbn').value;

      // Validation
      if (!validateBookId(bookId)) {
        showMessage('‚ùå Book ID must be alphanumeric', 'error');
        return;
      }

      if (!validateISBN(isbn)) {
        showMessage('‚ùå Invalid ISBN format', 'error');
        return;
      }

      const bookData = {
        bookId,
        bookName: document.getElementById('bookName').value,
        authorName: document.getElementById('authorName').value,
        isbn,
        quantity: document.getElementById('quantity').value
      };

      try {
        const response = await fetch('/api/add-book', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bookData)
        });

        const result = await response.json();

        if (response.ok) {
          // Show created books with their IDs
          if (result.books && result.books.length > 0) {
            const newIds = result.books.map(b => b.bookId).join(', ');
            if (result.books.length > 1) {
              showMessage(`‚úÖ Added ${result.books.length} books with IDs: ${newIds}`, 'success');
              showCreatedBooksSummary(result.books);
            } else {
              showMessage(`‚úÖ Book added with ID: ${newIds}`, 'success');
            }
          } else {
            showMessage('‚úÖ Book added successfully!', 'success');
          }
          document.getElementById('addBookForm').reset();
          clearDuplicateWarning();
        } else {
          if (result.isDuplicate) {
            showMessage('‚ö†Ô∏è This Book ID already exists. Use "Add More Copies" to add copies with new IDs.', 'error');
          } else {
            showMessage('‚ùå ' + (result.error || 'Error adding book'), 'error');
          }
        }
      } catch (error) {
        showMessage('‚ùå Error: ' + error.message, 'error');
      }
    });

    // Upload area drag and drop
    const uploadArea = document.getElementById('uploadArea');
    const csvFile = document.getElementById('csvFile');

    uploadArea.addEventListener('click', () => csvFile.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        csvFile.files = files;
        uploadCSV();
      }
    });

    csvFile.addEventListener('change', uploadCSV);

    // Upload CSV
    async function uploadCSV() {
      const file = document.getElementById('csvFile').files[0];
      if (!file) return;

      showMessage('‚è≥ Uploading and processing file...', 'info');

      const formData = new FormData();
      formData.append('csvFile', file);

      try {
        const response = await fetch('/api/upload-csv', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        let message = '';
        if (response.ok) {
          message = `‚úÖ Import Complete: ${result.imported} books added`;
          if (result.updated > 0) {
            message += ` | ${result.updated} books updated`;
          }
          if (result.duplicates > 0) {
            message += ` | ${result.duplicates} duplicates skipped`;
          }
          if (result.skipped > 0) {
            message += ` | ${result.skipped} invalid records`;
          }
          
          showMessage(message, 'success');
          
          // Show detailed summary
          if (result.details.updated || result.details.duplicates || result.details.skipped) {
            showImportSummary(result);
          }
        } else {
          message = `‚ö†Ô∏è Import Status: ${result.message || result.error}`;
          message += ` | Imported: ${result.imported || 0}`;
          if (result.updated > 0) {
            message += ` | Updated: ${result.updated}`;
          }
          showMessage(message, result.imported > 0 || result.updated > 0 ? 'success' : 'error');
          
          if (result.details) {
            showImportSummary(result);
          }
        }
        
        document.getElementById('csvFile').value = '';
      } catch (error) {
        showMessage('‚ùå Error: ' + error.message, 'error');
      }
    }

    // Show import summary
    function showImportSummary(result) {
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'import-summary';
      summaryDiv.innerHTML = '<h4>üìä Import Summary</h4>';

      if (result.details.updated && result.details.updated.length > 0) {
        summaryDiv.innerHTML += `<p><strong style="color: #28a745;">Updated Books (${result.details.updated.length}):</strong></p>`;
        result.details.updated.slice(0, 5).forEach(updated => {
          summaryDiv.innerHTML += `<div class="import-summary-item"><span>${updated.bookId}</span><span>${updated.bookName}</span><span style="color: #28a745;">Qty: ${updated.oldQuantity} ‚Üí ${updated.newQuantity}</span></div>`;
        });
        if (result.details.updated.length > 5) {
          summaryDiv.innerHTML += `<div class="import-summary-item"><span>... and ${result.details.updated.length - 5} more</span></div>`;
        }
      }

      if (result.details.duplicates && result.details.duplicates.length > 0) {
        summaryDiv.innerHTML += `<p style="margin-top: 12px;"><strong style="color: #1976D2;">Duplicates in File (${result.details.duplicates.length}):</strong></p>`;
        result.details.duplicates.slice(0, 5).forEach(dup => {
          summaryDiv.innerHTML += `<div class="import-summary-item"><span>${dup.bookId}</span><span>${dup.bookName}</span></div>`;
        });
        if (result.details.duplicates.length > 5) {
          summaryDiv.innerHTML += `<div class="import-summary-item"><span>... and ${result.details.duplicates.length - 5} more</span></div>`;
        }
      }

      if (result.details.skipped && result.details.skipped.length > 0) {
        summaryDiv.innerHTML += `<p style="margin-top: 12px;"><strong style="color: #1976D2;">Skipped (${result.details.skipped.length}):</strong></p>`;
        result.details.skipped.slice(0, 5).forEach(skip => {
          summaryDiv.innerHTML += `<div class="import-summary-item"><span>${skip.bookId}</span><span style="color: #dc3545;">${skip.reason}</span></div>`;
        });
      }

      const container = document.getElementById('message-container');
      container.appendChild(summaryDiv);
    }

    // Load books
    async function loadBooks() {
      try {
        const response = await fetch('/api/books');
        currentBooks = await response.json();

        const container = document.getElementById('booksContainer');
        
        // Count unique book titles
        const uniqueTitles = new Set(currentBooks.map(book => book.bookName)).size;
        document.getElementById('totalBooks').textContent = uniqueTitles;
        
        // Total copies (entries)
        document.getElementById('totalQuantity').textContent = currentBooks.length;

        if (currentBooks.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>üìö No books in your library yet</p>
              <p>Add books using the "Add Book" or "Import CSV" tabs</p>
            </div>
          `;
          document.getElementById('lastUpdated').textContent = '-';
          return;
        }

        displayBooks(currentBooks);

        // Update last updated date
        const lastBook = currentBooks[currentBooks.length - 1];
        document.getElementById('lastUpdated').textContent = lastBook.addedDate || 'N/A';
      } catch (error) {
        showMessage('‚ùå Error loading books: ' + error.message, 'error');
      }
    }

    // Display books table
    function displayBooks(books) {
      const container = document.getElementById('booksContainer');
      const table = document.createElement('table');
      table.className = 'books-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>Book ID</th>
            <th>Book Name</th>
            <th>Author Name</th>
            <th>ISBN</th>
            <th>Added Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          ${books.map(book => `
            <tr>
              <td><strong>${book.bookId}</strong></td>
              <td>${book.bookName}</td>
              <td>${book.authorName}</td>
              <td>${book.isbn}</td>
              <td>${book.addedDate}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-danger btn-small" onclick="deleteBook('${book.bookId}')">Delete</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      `;

      container.innerHTML = '';
      container.appendChild(table);
    }

    // Search books
    async function performSearch() {
      const query = document.getElementById('searchInput').value;
      const type = document.getElementById('searchType').value;

      if (!query) {
        showMessage('‚ö†Ô∏è Please enter a search term', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/search?query=${encodeURIComponent(query)}&type=${type}`);
        const results = await response.json();

        if (results.length === 0) {
          document.getElementById('booksContainer').innerHTML = `
            <div class="empty-state">
              <p>üîç No books found matching "${query}"</p>
            </div>
          `;
        } else {
          document.getElementById('totalBooks').textContent = results.length;
          displayBooks(results);
          showMessage(`‚úÖ Found ${results.length} book(s)`, 'success');
        }
      } catch (error) {
        showMessage('‚ùå Error searching books: ' + error.message, 'error');
      }
    }

    // Clear search
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchType').value = '';
      loadBooks();
      showMessage('üîÑ Search cleared', 'info');
    }

    // Delete book
    async function deleteBook(bookId) {
      if (!confirm('Are you sure you want to delete this book?')) return;

      try {
        const response = await fetch(`/api/books/${bookId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
          showMessage('‚úÖ Book deleted successfully!', 'success');
          loadBooks();
        } else {
          showMessage('‚ùå ' + (result.error || 'Error deleting book'), 'error');
        }
      } catch (error) {
        showMessage('‚ùå Error: ' + error.message, 'error');
      }
    }

    // Download CSV
    function downloadCSV() {
      window.location.href = '/api/download-csv';
    }
  </script>
</body>
</html>
